
CFLAGS += -DTARGET=7
CFLAGS += -DARCH_MICROBLAZE -Wall -O2
CFLAGS += -march=rv32imc -mabi=ilp32
CFLAGS += -Wl,-T -Wl,$(UAS_ROOT)/target/sakurax_picorv32/linker.ld

CC      = $(RISCV)/bin/riscv64-unknown-elf-gcc
LD      = $(RISCV)/bin/riscv64-unknown-elf-ld     
AS      = $(RISCV)/bin/riscv64-unknown-elf-as     
OBJDUMP = $(RISCV)/bin/riscv64-unknown-elf-objdump
OBJCOPY = $(RISCV)/bin/riscv64-unknown-elf-objcopy

TARGET_DIR  = $(UAS_ROOT)/target/sakurax_picorv32

TARGET_SRCS = $(TARGET_DIR)/sakurax_picorv32_bsp.c \
              $(TARGET_DIR)/sakurax_picorv32_boot.S 

UPDATEMEM       = $(VIVADO_ROOT)/bin/updatemem
VIVADO          = $(VIVADO_ROOT)/bin/vivado
VIVADO_LOG      = $(UAS_EXPERIMENT_BUILD)/vivado.log

IMPL_BITFILE    = $(TARGET_DIR)/bitstream.bit
DOWNLOAD_BITFILE= $(UAS_EXPERIMENT_BUILD)/download.bit

SEARCH_RAMB     = $(TARGET_DIR)/bitstream_search_ramb.tcl
MMI_GEN         = $(TARGET_DIR)/bitstream_mmi_gen.py

include fsbl/Makefile.in

$(DOWNLOAD_BITFILE) : $(IMPL_BITFILE) fsbl
	$(VIVADO) -mode tcl -log $(VIVADO_LOG) -nojournal \
        -source $(SEARCH_RAMB) \
        -tclargs sakurax_picorv32 $(UAS_BUILD)/vivado
	#$(UPDATEMEM) -force \
	#-meminfo $(MEMINFO) \
	#-bit     $(IMPL_BITFILE) \
	#-data    $(BINOUT) \
	#-proc    system_top_i/CPU_MB3 \
	#-out     $(DOWNLOAD_BITFILE)
	#@rm updatemem.jou updatemem.log

$(VIVADO_LOG) : $(IMPL_BITFILE) $(BINOUT)
	$(VIVADO) -mode tcl -log $(VIVADO_LOG) -nojournal \
        -source $(TARGET_DIR)/program_bitstream.tcl \
        -tclargs $(DOWNLOAD_BITFILE)
	@rm -f $(dir $(VIVADO_LOG))/vivado*backup.log
	
program: $(VIVADO_LOG)

recreate-vivado-project:
	cd $(UAS_BUILD)/vivado/ && \
	$(VIVADO) -source $(TARGET_DIR)/vivado_sakurax_picorv32.tcl \
        -mode tcl -nojournal -nolog \
        -tclargs --origin_dir $(TARGET_DIR) 

